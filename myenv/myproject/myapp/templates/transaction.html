{% extends "slidebar.html" %}
{% load static %}

{% block title %}Transactions - InsureBee Admin{% endblock %}

{% block page_title %}Transaction Management{% endblock %}

{% block additional_styles %}
.transaction-dashboard {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 20px;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    text-align: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card .icon {
    font-size: 26px;
    margin-bottom: 10px;
    color: var(--primary);
}

.stat-card .value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--text-dark);
}

.stat-card .label {
    color: #777;
    font-size: 14px;
}

.filter-section {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.filter-section select, 
.filter-section input {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    outline: none;
}

.filter-section select:focus, 
.filter-section input:focus {
    border-color: var(--primary);
}

.filter-section button {
    background-color: var(--primary);
    color: var(--text-dark);
    border: none;
    border-radius: 4px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.filter-section button:hover {
    background-color: var(--primary-dark);
}

.transaction-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.transaction-table thead th {
    background-color: #f2f2f2;
    color: var(--text-dark);
    padding: 12px 15px;
    text-align: left;
    border-bottom: 2px solid #ddd;
}

.transaction-table tbody tr {
    border-bottom: 1px solid #ddd;
    transition: background-color 0.3s;
}

.transaction-table tbody tr:hover {
    background-color: #f8f9fa;
}

.transaction-table td {
    padding: 12px 15px;
}

.transaction-status {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-success {
    background-color: #d4edda;
    color: #155724;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-failed {
    background-color: #f8d7da;
    color: #721c24;
}

.status-refunded {
    background-color: #d1ecf1;
    color: #0c5460;
}

.action-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 5px;
    font-size: 12px;
}

.view-btn {
    background-color: #e9ecef;
    color: #495057;
}

.view-btn:hover {
    background-color: #dee2e6;
}

.pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    list-style: none;
}

.pagination li {
    margin: 0 5px;
}

.pagination a {
    display: inline-block;
    padding: 8px 12px;
    background-color: #fff;
    border: 1px solid #ddd;
    color: var(--text-dark);
    text-decoration: none;
    border-radius: 4px;
}

.pagination a:hover {
    background-color: #f8f9fa;
}

.pagination .active a {
    background-color: var(--primary);
    border-color: var(--primary);
    color: var(--text-dark);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 8px;
    width: 70%;
    max-width: 700px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    position: relative;
}

.close {
    position: absolute;
    right: 15px;
    top: 10px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

.transaction-details {
    margin-top: 20px;
}

.detail-row {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
}

.detail-label {
    width: 30%;
    font-weight: bold;
    color: #555;
}

.detail-value {
    width: 70%;
}

@media (max-width: 768px) {
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
    
    .filter-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .transaction-table {
        display: block;
        overflow-x: auto;
    }
    
    .modal-content {
        width: 95%;
        margin: 5% auto;
    }
    
    .detail-row {
        flex-direction: column;
    }
    
    .detail-label, .detail-value {
        width: 100%;
    }
}
{% endblock %}

{% block content %}
<div class="transaction-dashboard">
    <!-- Dashboard Statistics -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="icon">
                <i class="fas fa-money-check-alt"></i>
            </div>
            <div class="value">{{ total_transactions }}</div>
            <div class="label">Total Transactions</div>
        </div>
        
        <div class="stat-card">
            <div class="icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="value">{{ successful_transactions }}</div>
            <div class="label">Successful</div>
        </div>
        
        <div class="stat-card">
            <div class="icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="value">{{ pending_transactions }}</div>
            <div class="label">Pending</div>
        </div>
        
        <div class="stat-card">
            <div class="icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="value">{{ failed_transactions }}</div>
            <div class="label">Failed</div>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <input type="text" id="search-input" placeholder="Search by ID, customer or policy">
        
        <select id="filter-status">
            <option value="">All Statuses</option>
            <option value="success">Success</option>
            <option value="pending">Pending</option>
            <option value="failed">Failed</option>
            <option value="refunded">Refunded</option>
        </select>
        
        <select id="filter-type">
            <option value="">All Types</option>
            <option value="premium">Premium</option>
            <option value="claim">Claim Payout</option>
            <option value="refund">Refund</option>
            <option value="admin">Admin Fee</option>
        </select>
        
        <input type="date" id="date-from" placeholder="Date From">
        <input type="date" id="date-to" placeholder="Date To">
        
        <button id="filter-button">Apply Filters</button>
        <button id="reset-filters">Reset</button>
    </div>
    
    <!-- Transactions Table -->
    <div class="table-responsive">
        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Policy ID</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="transactions-body">
                {% for transaction in transactions %}
                <tr>
                    <td>{{ transaction.transaction_id }}</td>
                    <td>{{ transaction.booking_date }}</td>
                    <td>{{ transaction.user.name }}</td>
                    <td>{{ transaction.policy_id }}</td>
                    <td>{{ transaction.policy.policy_type|capfirst }} Insurance</td>
                    <td>₹{{ transaction.amt_paid }}</td>
                    <td>
                        <span class="transaction-status status-{{ transaction.payment_status|lower }}">
                            {{ transaction.payment_status }}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn view-btn" 
                                data-id="{{ transaction.transaction_id }}"
                                data-date="{{ transaction.booking_date }}"
                                data-customer="{{ transaction.user.name }}"
                                data-policy="{{ transaction.policy.policyNo }}"
                                data-provider="{{ transaction.policy.provider }}"
                                data-type="{{ transaction.policy.policy_type | capfirst }} Insurance"
                                data-amount="₹ {{ transaction.amt_paid }}"
                                data-status="{{ transaction.payment_status }}"
                                data-coverage="₹ {{ transaction.policy.coverage_amount }}"
                                data-description="{{ transaction.description }}"
                                onclick="viewTransaction(this)">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <ul class="pagination">
        <li><a href="#" id="prev-page">&laquo;</a></li>
        <li class="active"><a href="#">1</a></li>
        <li><a href="#">2</a></li>
        <li><a href="#">3</a></li>
        <li><a href="#">4</a></li>
        <li><a href="#">5</a></li>
        <li><a href="#" id="next-page">&raquo;</a></li>
    </ul>
</div>

<!-- Transaction Detail Modal -->
<div id="transaction-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Transaction Details</h2>
        {% for transaction in transactions %}
        <div class="transaction-details">
            <div class="detail-row">
                <div class="detail-label">Transaction ID:</div>
                <div class="detail-value" id="modal-transaction-id">{{ transaction.id }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Date & Time:</div>
                <div class="detail-value" id="modal-date">{{ transaction.booking_date }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Customer:</div>
                <div class="detail-value" id="modal-customer">{{ transaction.user.name }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Policy ID:</div>
                <div class="detail-value" id="modal-policy">{{ transaction.policy.policyNo }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Provider:</div>
                <div class="detail-value" id="modal-provider">{{ transaction.policy.provider }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Type:</div>
                <div class="detail-value" id="modal-type">{{ transaction.policy.policy_type |capfirst }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Amount:</div>
                <div class="detail-value" id="modal-amount">{{ transaction.amt_paid }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <div class="detail-value" id="modal-status">{{ transaction.payment_status }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Coverage Amount:</div>
                <div class="detail-value" id="modal-payment-method">{{ transaction.coverage_amount }}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Description:</div>
                <div class="detail-value" id="modal-description">{{ transaction.description }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block additional_scripts %}

    // Sample transaction data for demonstration
    const transactionData = [
        {
            transaction_id: "TRX-10001",
            date: "2025-04-20 14:32:45",
            customer_name: "John Smith",
            policy_id: "POL-2025-001",
            provider: "AllState Insurance",
            type: "Premium",
            amount: "450.00",
            status: "Success",
            payment_method: "Credit Card (Visa ending in 4242)",
            description: "Monthly premium payment for home insurance policy."
        },
        {
            transaction_id: "TRX-10002",
            date: "2025-04-18 09:15:22",
            customer_name: "Sarah Johnson",
            policy_id: "POL-2025-042",
            provider: "Liberty Mutual",
            type: "Claim Payout",
            amount: "1,250.00",
            status: "Pending",
            payment_method: "Bank Transfer",
            description: "Claim payout for water damage repair."
        },
        {
            transaction_id: "TRX-10003",
            date: "2025-04-15 16:45:11",
            customer_name: "Michael Davis",
            policy_id: "POL-2025-028",
            provider: "Progressive",
            type: "Premium",
            amount: "210.75",
            status: "Failed",
            payment_method: "Credit Card (declined)",
            description: "Quarterly premium payment for auto insurance policy."
        },
        {
            transaction_id: "TRX-10004",
            date: "2025-04-12 11:20:36",
            customer_name: "Emily Wilson",
            policy_id: "POL-2025-103",
            provider: "State Farm",
            type: "Refund",
            amount: "85.25",
            status: "Refunded",
            payment_method: "Original Payment Method",
            description: "Partial refund for policy cancellation."
        }
    ];

    
    function viewTransaction(button) {
        // Get data from the button's data attributes
        document.getElementById('modal-transaction-id').textContent = button.getAttribute('data-id');
        document.getElementById('modal-date').textContent = button.getAttribute('data-date');
        document.getElementById('modal-customer').textContent = button.getAttribute('data-customer');
        document.getElementById('modal-policy').textContent = button.getAttribute('data-policy');
        document.getElementById('modal-provider').textContent = button.getAttribute('data-provider');
        document.getElementById('modal-type').textContent = button.getAttribute('data-type');
        document.getElementById('modal-amount').textContent = button.getAttribute('data-amount');
        document.getElementById('modal-status').textContent = button.getAttribute('data-status');
        document.getElementById('modal-payment-method').textContent = button.getAttribute('data-coverage');
        document.getElementById('modal-description').textContent = button.getAttribute('data-description');
        
        // Show modal
        document.getElementById('transaction-modal').style.display = 'block';
    }

    // Close modal when clicking on X
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('transaction-modal').style.display = 'none';
    });

    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
        if (event.target == document.getElementById('transaction-modal')) {
            document.getElementById('transaction-modal').style.display = 'none';
        }
    });

    // Filter button functionality
    document.getElementById('filter-button').addEventListener('click', function() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const typeFilter = document.getElementById('filter-type').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        
        // Here you would normally make an AJAX request to filter data on the server
        // For demo purposes, we'll just log the filter values
        console.log('Filtering with:', {
            searchTerm,
            statusFilter,
            typeFilter,
            dateFrom,
            dateTo
        });
        
        alert('Filter applied! In a real implementation, this would refresh the table with filtered data.');
    });

    // Reset filters
    document.getElementById('reset-filters').addEventListener('click', function() {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-type').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
    });

    // Pagination clicks (demo only)
    document.querySelectorAll('.pagination a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all pagination items
            document.querySelectorAll('.pagination li').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item's parent
            if (this.id !== 'prev-page' && this.id !== 'next-page') {
                this.parentElement.classList.add('active');
            }
            
            // Here you would fetch the appropriate page of data
            console.log('Navigating to page:', this.textContent);
        });
    });

{% endblock %}