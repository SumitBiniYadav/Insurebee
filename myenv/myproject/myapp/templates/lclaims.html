{% extends "slidebar.html" %}

{% block title %}InsureBee Claims Management{% endblock %}

{% block page_title %}Claims Management{% endblock %}

{% block additional_styles %}
/* Claims Overview Stats */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: rgba(255, 193, 7, 0.2);
    color: var(--primary);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    margin-bottom: 15px;
}

.stat-card h3 {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.stat-card .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-dark);
}

.stat-card .stat-change {
    margin-top: 10px;
    font-size: 14px;
}

.positive-change {
    color: #4caf50;
}

.negative-change {
    color: #f44336;
}

/* Claims Filters Section */
.filters-container {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.filters-title {
    margin-bottom: 15px;
    color: var(--text-dark);
    font-weight: bold;
}

.filters-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.filter-group {
    margin-bottom: 0;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #666;
}

.filter-group select,
.filter-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.filter-button {
    padding: 8px 15px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
    border: none;
}

.apply-button {
    background-color: var(--primary);
    color: var(--text-dark);
    font-weight: bold;
}

.apply-button:hover {
    background-color: var(--primary-dark);
}

.reset-button {
    background-color: #f5f5f5;
    color: #666;
}

.reset-button:hover {
    background-color: #e0e0e0;
}

/* Claims Table Section */
.claims-table-container {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.claims-table {
    width: 100%;
    border-collapse: collapse;
}

.claims-table th,
.claims-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.claims-table th {
    background-color: #f5f5f5;
    color: #666;
    font-weight: bold;
    position: sticky;
    top: 0;
}

.claims-table tr:hover {
    background-color: #f9f9f9;
}

.claims-table td:last-child {
    text-align: center;
}

.claim-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s;
    border: none;
}

.view-btn {
    background-color: rgba(255, 193, 7, 0.2);
    color: var(--primary-dark);
}

.view-btn:hover {
    background-color: rgba(255, 193, 7, 0.4);
}

.approve-btn {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.approve-btn:hover {
    background-color: rgba(76, 175, 80, 0.2);
}

.reject-btn {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
}

.reject-btn:hover {
    background-color: rgba(244, 67, 54, 0.2);
}

/* Status Badges */
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    display: inline-block;
}

.status-review {
    background-color: rgba(255, 193, 7, 0.2);
    color: var(--primary-dark);
}

.status-approved {
    background-color: rgba(76, 175, 80, 0.2);
    color: #4caf50;
}

.status-rejected {
    background-color: rgba(244, 67, 54, 0.2);
    color: #f44336;
}

.status-completed {
    background-color: rgba(33, 150, 243, 0.2);
    color: #2196f3;
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    gap: 5px;
}

.pagination-btn {
    padding: 8px 12px;
    border-radius: 4px;
    background-color: #f5f5f5;
    color: #666;
    cursor: pointer;
    transition: background-color 0.3s;
    border: none;
}

.pagination-btn:hover,
.pagination-btn.active {
    background-color: var(--primary);
    color: var(--text-dark);
}

/* Claim Detail Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 800px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    position: relative;
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
    color: #888;
}

.modal-header {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.modal-title {
    font-size: 18px;
    color: var(--text-dark);
    margin: 0;
}

.claim-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.detail-group {
    margin-bottom: 15px;
}

.detail-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.detail-value {
    font-size: 16px;
    color: var(--text-dark);
    font-weight: bold;
}

.claim-reason {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.claim-documents {
    margin-bottom: 20px;
}

.document-link {
    display: inline-block;
    padding: 8px 15px;
    background-color: #f5f5f5;
    color: #666;
    border-radius: 4px;
    text-decoration: none;
    margin-right: 10px;
    transition: background-color 0.3s;
}

.document-link:hover {
    background-color: #e0e0e0;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

.modal-btn {
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s;
    border: none;
}

.approve-modal-btn {
    background-color: #4caf50;
    color: white;
}

.approve-modal-btn:hover {
    background-color: #3d8b40;
}

.reject-modal-btn {
    background-color: #f44336;
    color: white;
}

.reject-modal-btn:hover {
    background-color: #d32f2f;
}

.review-notes {
    margin-top: 20px;
}

.review-notes textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    min-height: 100px;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .filters-form {
        grid-template-columns: 1fr;
    }
    
    .claims-table {
        display: block;
        overflow-x: auto;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .claim-details {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<!-- Claims Stats Overview -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-file-invoice"></i>
        </div>
        <h3>TOTAL CLAIMS</h3>
        <div class="stat-value">{{ total_claims }}</div>
        <div class="stat-change positive-change">
            <i class="fas fa-arrow-up"></i> 5% this month
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <h3>UNDER REVIEW</h3>
        <div class="stat-value">{{ under_review_claims }}</div>
        <div class="stat-change negative-change">
            <i class="fas fa-arrow-down"></i> 2% this month
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3>APPROVED CLAIMS</h3>
        <div class="stat-value">{{ approved_claims }}</div>
        <div class="stat-change positive-change">
            <i class="fas fa-arrow-up"></i> 8% this month
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-check-alt"></i>
        </div>
        <h3>CLAIM AMOUNT</h3>
        <div class="stat-value">â‚¹{{ total_claim_amount }}</div>
        <div class="stat-change positive-change">
            <i class="fas fa-arrow-up"></i> 12% this month
        </div>
    </div>
</div>

<!-- Claims Filters -->
<div class="filters-container">
    <h3 class="filters-title">Filter Claims</h3>
    <form class="filters-form" method="get" action="{% url 'lclaims' %}">
        <div class="filter-group">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="">All Statuses</option>
                <option value="under_review" {% if status == 'under_review' %}selected{% endif %}>Under Review</option>
                <option value="approved" {% if status == 'approved' %}selected{% endif %}>Approved</option>
                <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="date_from">Date From</label>
            <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
        </div>
        <div class="filter-group">
            <label for="date_to">Date To</label>
            <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
        </div>
        <div class="filter-group">
            <label for="min_amount">Min Amount (â‚¹)</label>
            <input type="number" id="min_amount" name="min_amount" value="{{ min_amount }}">
        </div>
        <div class="filter-group">
            <label for="max_amount">Max Amount (â‚¹)</label>
            <input type="number" id="max_amount" name="max_amount" value="{{ max_amount }}">
        </div>
        <div class="filter-group">
            <label for="policy_type">Policy Type</label>
            <select id="policy_type" name="policy_type">
                <option value="">All Types</option>
                <option value="life" {% if policy_type == 'life' %}selected{% endif %}>Life Insurance</option>
                <option value="health" {% if policy_type == 'health' %}selected{% endif %}>Health Insurance</option>
                <option value="auto" {% if policy_type == 'auto' %}selected{% endif %}>Auto Insurance</option>
                <option value="home" {% if policy_type == 'home' %}selected{% endif %}>Home Insurance</option>
                <option value="business" {% if policy_type == 'business' %}selected{% endif %}>Business Insurance</option>
            </select>
        </div>
        <div class="filter-buttons">
            <button type="submit" class="filter-button apply-button">Apply Filters</button>
            <button type="reset" class="filter-button reset-button">Reset Filters</button>
        </div>
    </form>
</div>

<!-- Claims Table -->
<div class="claims-table-container">
    <table class="claims-table">
        <thead>
            <tr>
                <th>Claim ID</th>
                <th>Customer</th>
                <th>Policy No.</th>
                <th>Policy Type</th>
                <th>Claim Date</th>
                <th>Amount (â‚¹)</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for claim in claims %}
            <tr>
                <td>{{ claim.id }}</td>
                <td>{{ claim.user.name }}</td>
                <td>{{ claim.booking.policy.policyNo }}</td>
                <td>{{ claim.booking.policy.policy_type|capfirst }} Insurance</td>
                <td>{{ claim.claim_date }}</td>
                <td>â‚¹{{ claim.claim_amount }}</td>
                <td>
                    {% if claim.status == 'under_review' %}
                    <span class="status-badge status-review">Under Review</span>
                    {% elif claim.status == 'approved' %}
                    <span class="status-badge status-approved">Approved</span>
                    {% elif claim.status == 'rejected' %}
                    <span class="status-badge status-rejected">Rejected</span>
                    {% elif claim.status == 'completed' %}
                    <span class="status-badge status-completed">Completed</span>
                    {% endif %}
                </td>
                <td>
                    <div class="claim-actions">
                        <button class="action-btn view-btn" onclick="window.location.href='{% url 'lclaimsview' claim.id %}'">View</button>
                        {% if claim.status == 'under_review' %}
                        <button class="action-btn approve-btn" onclick="approveClaim({{ claim.id }})">Approve</button>
                        <button class="action-btn reject-btn" onclick="rejectClaim({{ claim.id }})">Reject</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 20px;">No claims found matching your filters.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination">
    {% if claims.has_previous %}
    <a href="?page=1" class="pagination-btn">&laquo; First</a>
    <a href="?page={{ claims.previous_page_number }}" class="pagination-btn">&lsaquo; Previous</a>
    {% endif %}
    
    {% for num in claims.paginator.page_range %}
        {% if claims.number == num %}
        <span class="pagination-btn active">{{ num }}</span>
        {% elif num > claims.number|add:'-3' and num < claims.number|add:'3' %}
        <a href="?page={{ num }}" class="pagination-btn">{{ num }}</a>
        {% endif %}
    {% endfor %}
    
    {% if claims.has_next %}
    <a href="?page={{ claims.next_page_number }}" class="pagination-btn">Next &rsaquo;</a>
    <a href="?page={{ claims.paginator.num_pages }}" class="pagination-btn">Last &raquo;</a>
    {% endif %}
</div>

<!-- Claim Detail Modal -->
<div id="claimModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeClaimModal()">&times;</span>
        <div class="modal-header">
            <h2 class="modal-title">Claim Details</h2>
        </div>
        <div id="claim-detail-content">
            <!-- This will be populated with AJAX -->
            <div class="claim-details">
                <div class="detail-group">
                    <div class="detail-label">Claim ID</div>
                    <div class="detail-value" id="modal-claim-id"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Customer Name</div>
                    <div class="detail-value" id="modal-customer-name"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Policy Number</div>
                    <div class="detail-value" id="modal-policy-no"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Policy Type</div>
                    <div class="detail-value" id="modal-policy-type"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Claim Date</div>
                    <div class="detail-value" id="modal-claim-date"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Claim Amount</div>
                    <div class="detail-value" id="modal-claim-amount"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value" id="modal-claim-status"></div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Verification Status</div>
                    <div class="detail-value" id="modal-verification-status"></div>
                </div>
            </div>
            
            <h3>Claim Reason</h3>
            <div class="claim-reason" id="modal-claim-reason">
                <!-- Claim reason text will be populated here -->
            </div>
            
            <h3>Supporting Documents</h3>
            <div class="claim-documents">
                <a href="#" class="document-link" id="modal-document-link">
                    <i class="fas fa-file-pdf"></i> View Document
                </a>
            </div>
            
            <div class="review-notes">
                <h3>Review Notes</h3>
                <textarea id="review-notes-input" placeholder="Enter your notes about this claim..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button id="modal-approve-btn" class="modal-btn approve-modal-btn" style="display: none;">Approve Claim</button>
            <button id="modal-reject-btn" class="modal-btn reject-modal-btn" style="display: none;">Reject Claim</button>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
    // Function to open claim modal and load data
    function openClaimModal(claimId) {
        // In a real application, this would make an AJAX request to get claim details
        // For now, we'll simulate loading the data
        
        // Show loading state
        document.getElementById('loading-screen').style.display = 'flex';
        
        // Simulate API call with setTimeout
        setTimeout(() => {
            // Here you would normally fetch data from server
            // For demo purposes, we'll hardcode values for claim with ID matching from the table
            
            const modal = document.getElementById('claimModal');
            
            // Find the claim in the table
            const claimRow = document.querySelector(`tr td:first-child:contains('${claimId}')`).parentNode;
            if (claimRow) {
                const cells = claimRow.querySelectorAll('td');
                
                // Populate modal with data from the table row
                document.getElementById('modal-claim-id').textContent = cells[0].textContent;
                document.getElementById('modal-customer-name').textContent = cells[1].textContent;
                document.getElementById('modal-policy-no').textContent = cells[2].textContent;
                document.getElementById('modal-policy-type').textContent = cells[3].textContent;
                document.getElementById('modal-claim-date').textContent = cells[4].textContent;
                document.getElementById('modal-claim-amount').textContent = cells[5].textContent;
                
                const statusText = cells[6].querySelector('.status-badge').textContent;
                document.getElementById('modal-claim-status').textContent = statusText;
                
                // Set verification status (simulated)
                document.getElementById('modal-verification-status').textContent = 
                    statusText === 'Under Review' ? 'Pending Verification' : 'Verified';
                
                // Set claim reason (simulated)
                document.getElementById('modal-claim-reason').textContent = 
                    "The insured vehicle was involved in a collision with another vehicle at an intersection. The accident occurred when the other driver ran a red light, causing significant damage to the front end of the insured vehicle. A police report has been filed and the other driver has accepted fault.";
                
                // Set document link (simulated)
                document.getElementById('modal-document-link').href = "#document-" + claimId;
                
                // Show/hide action buttons based on status
                const approveBtn = document.getElementById('modal-approve-btn');
                const rejectBtn = document.getElementById('modal-reject-btn');
                
                if (statusText === 'Under Review') {
                    approveBtn.style.display = 'block';
                    rejectBtn.style.display = 'block';
                    
                    // Set action handlers
                    approveBtn.onclick = function() {
                        approveClaimFromModal(claimId);
                    };
                    
                    rejectBtn.onclick = function() {
                        rejectClaimFromModal(claimId);
                    };
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }
            }
            
            // Hide loading and show modal
            document.getElementById('loading-screen').style.display = 'none';
            modal.style.display = 'block';
        }, 500);
    }

    // Function to close claim modal
    function closeClaimModal() {
        const modal = document.getElementById('claimModal');
        modal.style.display = 'none';
    }

    // Function to approve claim from the table
    function approveClaim(claimId) {
        if (confirm('Are you sure you want to approve this claim?')) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // In a real application, this would make an AJAX request to update the claim status
            // For demo, we'll simulate the process
            setTimeout(() => {
                // Update UI to reflect the change
                updateClaimStatus(claimId, 'approved');
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert('Claim #' + claimId + ' has been approved successfully!');
            }, 800);
        }
    }

    // Function to reject claim from the table
    function rejectClaim(claimId) {
        if (confirm('Are you sure you want to reject this claim?')) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // In a real application, this would make an AJAX request to update the claim status
            // For demo, we'll simulate the process
            setTimeout(() => {
                // Update UI to reflect the change
                updateClaimStatus(claimId, 'rejected');
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert('Claim #' + claimId + ' has been rejected.');
            }, 800);
        }
    }

    // Function to approve claim from the modal
    function approveClaimFromModal(claimId) {
        const notes = document.getElementById('review-notes-input').value;
        
        if (!notes.trim()) {
            alert('Please add review notes before approving the claim.');
            return;
        }
        
        if (confirm('Are you sure you want to approve this claim?')) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // In a real application, this would make an AJAX request to update the claim status
            // For demo, we'll simulate the process
            setTimeout(() => {
                // Update UI to reflect the change
                updateClaimStatus(claimId, 'approved');
                
                // Close the modal
                closeClaimModal();
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert('Claim #' + claimId + ' has been approved successfully with notes: ' + notes);
            }, 800);
        }
    }

    // Function to reject claim from the modal
    function rejectClaimFromModal(claimId) {
        const notes = document.getElementById('review-notes-input').value;
        
        if (!notes.trim()) {
            alert('Please add review notes before rejecting the claim.');
            return;
        }
        
        if (confirm('Are you sure you want to reject this claim?')) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // In a real application, this would make an AJAX request to update the claim status
            // For demo, we'll simulate the process
            setTimeout(() => {
                // Update UI to reflect the change
                updateClaimStatus(claimId, 'rejected');
                
                // Close the modal
                closeClaimModal();
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert('Claim #' + claimId + ' has been rejected with notes: ' + notes);
            }, 800);
        }
    }

    // Helper function to update claim status in the UI
    function updateClaimStatus(claimId, newStatus) {
        // Find the claim row
        const claimRow = document.querySelector(`tr td:first-child:contains('${claimId}')`).parentNode;
        if (!claimRow) return;
        
        // Get the status cell
        const statusCell = claimRow.querySelector('td:nth-child(7)');
        if (!statusCell) return;
        
        // Get the actions cell
        const actionsCell = claimRow.querySelector('td:last-child');
        if (!actionsCell) return;
        
        // Update the status display
        let statusHTML = '';
        if (newStatus === 'approved') {
            statusHTML = '<span class="status-badge status-approved">Approved</span>';
        } else if (newStatus === 'rejected') {
            statusHTML = '<span class="status-badge status-rejected">Rejected</span>';
        }
        
        statusCell.innerHTML = statusHTML;
        
        // Update the actions - remove approve/reject buttons
        actionsCell.innerHTML = '<div class="claim-actions"><button class="action-btn view-btn" onclick="openClaimModal(' + claimId + ')">View</button></div>';
        
        // Update stats at the top (simplified for demo)
        if (newStatus === 'approved') {
            // Decrease under review count
            const reviewCount = document.querySelector('.stats-container .stat-card:nth-child(2) .stat-value');
            const approvedCount = document.querySelector('.stats-container .stat-card:nth-child(3) .stat-value');
            
            if (reviewCount && approvedCount) {
                const currentReviewCount = parseInt(reviewCount.textContent);
                const currentApprovedCount = parseInt(approvedCount.textContent);
                
                reviewCount.textContent = currentReviewCount - 1;
                approvedCount.textContent = currentApprovedCount + 1;
            }
        } else if (newStatus === 'rejected') {
            // Decrease under review count
            const reviewCount = document.querySelector('.stats-container .stat-card:nth-child(2) .stat-value');
            
            if (reviewCount) {
                const currentReviewCount = parseInt(reviewCount.textContent);
                reviewCount.textContent = currentReviewCount - 1;
            }
        }
    }

    // jQuery-like helper function for selector :contains
    document.querySelectorAll = document.querySelectorAll || function(selector) {
        if (selector.includes(':contains(')) {
            const parts = selector.split(':contains(');
            const baseSelector = parts[0];
            const searchText = parts[1].slice(0, -1);
            
            const elements = document.querySelectorAll(baseSelector);
            const results = [];
            
            elements.forEach(element => {
                if (element.textContent.includes(searchText)) {
                    results.push(element);
                }
            });
            
            return results;
        } else {
            return document.querySelectorAll(selector);
        }
    };

    // Add event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listener for the modal close button
        const closeBtn = document.querySelector('.close-modal');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeClaimModal);
        }
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('claimModal');
            if (event.target === modal) {
                closeClaimModal();
            }
        });
        
        // Add event listeners for filter form reset button
        const resetBtn = document.querySelector('.reset-button');
        if (resetBtn) {
            resetBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = document.querySelector('.filters-form');
                form.reset();
                form.submit();
            });
        }
        
        // Initialize date pickers with defaults if empty
        const dateFrom = document.getElementById('date_from');
        const dateTo = document.getElementById('date_to');
        
        if (dateFrom && !dateFrom.value) {
            // Set default to 30 days ago
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            dateFrom.value = formatDate(thirtyDaysAgo);
        }
        
        if (dateTo && !dateTo.value) {
            // Set default to today
            const today = new Date();
            dateTo.value = formatDate(today);
        }
    });

    // Helper function to format date as YYYY-MM-DD
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Export CSV function
    function exportClaimsToCSV() {
        // In a real application, this would either use the current data or make an API request
        // to get all filtered claims data for export
        
        // Show loading state
        document.getElementById('loading-screen').style.display = 'flex';
        
        setTimeout(() => {
            try {
                // Get table headers
                const headers = [];
                document.querySelectorAll('.claims-table th').forEach(th => {
                    // Skip the Actions column
                    if (th.textContent !== 'Actions') {
                        headers.push(th.textContent);
                    }
                });
                
                // Get table data
                const rows = [];
                document.querySelectorAll('.claims-table tbody tr').forEach(tr => {
                    const row = [];
                    tr.querySelectorAll('td').forEach((td, index) => {
                        // Skip the Actions column
                        if (index < 7) {
                            // For status column, get the text content of the span
                            if (index === 6) {
                                const statusSpan = td.querySelector('.status-badge');
                                row.push(statusSpan ? statusSpan.textContent : '');
                            } else {
                                row.push(td.textContent);
                            }
                        }
                    });
                    
                    rows.push(row);
                });
                
                // Generate CSV content
                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => {
                    csvContent += row.join(',') + '\n';
                });
                
                // Create a download link and trigger it
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'claims_export.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('An error occurred while exporting claims data.');
                document.getElementById('loading-screen').style.display = 'none';
            }
        }, 800);
    }

    // Bulk action functions
    function approveSelectedClaims() {
        const selectedCheckboxes = document.querySelectorAll('.claim-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one claim to approve.');
            return;
        }
        
        if (confirm(`Are you sure you want to approve ${selectedCheckboxes.length} claims?`)) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Process each selected claim
            setTimeout(() => {
                selectedCheckboxes.forEach(checkbox => {
                    const claimId = checkbox.value;
                    updateClaimStatus(claimId, 'approved');
                });
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert(`${selectedCheckboxes.length} claims have been approved successfully!`);
                
                // Uncheck select all checkbox
                const selectAllCheckbox = document.getElementById('select-all-claims');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }, 1200);
        }
    }

    function rejectSelectedClaims() {
        const selectedCheckboxes = document.querySelectorAll('.claim-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            alert('Please select at least one claim to reject.');
            return;
        }
        
        if (confirm(`Are you sure you want to reject ${selectedCheckboxes.length} claims?`)) {
            // Show loading state
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Process each selected claim
            setTimeout(() => {
                selectedCheckboxes.forEach(checkbox => {
                    const claimId = checkbox.value;
                    updateClaimStatus(claimId, 'rejected');
                });
                
                // Hide loading screen
                document.getElementById('loading-screen').style.display = 'none';
                
                // Show success message
                alert(`${selectedCheckboxes.length} claims have been rejected!`);
                
                // Uncheck select all checkbox
                const selectAllCheckbox = document.getElementById('select-all-claims');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }, 1200);
        }
    }

    // Select all functionality
    function toggleSelectAllClaims(source) {
        const checkboxes = document.querySelectorAll('.claim-checkbox');
        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const statusBadge = row.querySelector('.status-badge');
            
            // Only select claims that are under review
            if (statusBadge && statusBadge.textContent === 'Under Review') {
                checkbox.checked = source.checked;
            }
        });
    }

{% endblock %}